name: Deploy to GCE (SSH + PM2)

on:
  push:
    branches: [main]

defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SERVER_HOST }}
      SSH_USER: ${{ secrets.SERVER_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DEPLOY_PATH: ${{ secrets.SERVER_PATH }}
      PM2_APP_NAME: poc-api-vrcapi   # ← Secretが無いので固定値にするか、PM2_APP_NAMEを作成

    steps:
      - name: Validate required inputs
        run: |
          set -Eeuo pipefail
          for v in SSH_HOST SSH_USER SSH_PRIVATE_KEY DEPLOY_PATH PM2_APP_NAME; do
            if [ -z "${!v:-}" ]; then
              echo "::error title=Missing::$v is empty."
              exit 1
            fi
          done

      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Build deploy bundle
        run: |
          set -Eeuo pipefail
          mkdir -p .deploy
          tar --exclude='.git' --exclude='node_modules' -czf .deploy/deploy.tar.gz .

      - name: Setup SSH
        run: |
          set -Eeuo pipefail
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> "$HOME/.ssh/known_hosts"

      - name: Copy bundle
        run: scp -P "$SSH_PORT" .deploy/deploy.tar.gz "$SSH_USER@$SSH_HOST:/tmp/deploy.tar.gz"

      - name: Diagnostic - Check Node.js installation
        continue-on-error: true
        run: |
          echo "========================================="
          echo "DIAGNOSTIC: Checking Node.js installation"
          echo "========================================="
          cat > /tmp/check-node.sh <<'CHECKEOF'
          #!/bin/bash
          echo "=== Checking Node.js installation ==="
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo ""
          echo "Shell config files:"
          ls -la ~/.bashrc ~/.bash_profile ~/.profile ~/.zshrc 2>&1 | grep -v "cannot access" || true
          echo ""
          echo "Initial PATH: $PATH"
          echo ""
          echo "Sourcing shell configs..."
          [ -f ~/.bashrc ] && source ~/.bashrc && echo "Sourced ~/.bashrc"
          [ -f ~/.bash_profile ] && source ~/.bash_profile && echo "Sourced ~/.bash_profile"
          [ -f ~/.profile ] && source ~/.profile && echo "Sourced ~/.profile"
          echo "PATH after sourcing: $PATH"
          echo ""
          echo "Checking for NVM..."
          ls -la ~/.nvm 2>&1 || echo "~/.nvm not found"
          [ -s "$HOME/.nvm/nvm.sh" ] && echo "NVM script exists" || echo "NVM script not found"
          echo ""
          echo "Looking for node in filesystem (this may take a moment)..."
          find ~ -name "node" -type f -executable 2>/dev/null | head -10 || echo "No node found"
          echo ""
          echo "Checking system paths..."
          ls -la /usr/local/bin/node /usr/bin/node 2>&1 | grep -v "cannot access" || echo "node not in system paths"
          ls -la /usr/local/bin/npm /usr/bin/npm 2>&1 | grep -v "cannot access" || echo "npm not in system paths"
          echo ""
          which node || echo "node not in PATH"
          which npm || echo "npm not in PATH"
          which pm2 || echo "pm2 not in PATH"
          echo ""
          echo "=== Diagnostic complete ==="
          CHECKEOF
          chmod +x /tmp/check-node.sh
          scp -P "$SSH_PORT" /tmp/check-node.sh "$SSH_USER@$SSH_HOST:/tmp/check-node.sh"
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "bash /tmp/check-node.sh" || echo "Diagnostic completed with errors (non-fatal)"
          echo "========================================="

      - name: Create deploy script
        run: |
          cat > /tmp/deploy-script.sh <<'SCRIPT_END'
          #!/bin/bash
          set -Eeuo pipefail

          # Load environment files
          [ -f ~/.bashrc ] && source ~/.bashrc
          [ -f ~/.bash_profile ] && source ~/.bash_profile
          [ -f ~/.profile ] && source ~/.profile

          # Load NVM
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"

          # Try to find node/npm in common locations
          for node_path in \
            "$HOME/.nvm/versions/node/*/bin" \
            "/usr/local/bin" \
            "/opt/nodejs/bin" \
            "$HOME/.local/bin"; do
            if [ -d "$node_path" ] && [ -x "$node_path/node" ]; then
              export PATH="$node_path:$PATH"
              break
            fi
          done

          # Debug: Show what we found
          echo "Node version: $(node --version 2>&1 || echo 'not found')"
          echo "NPM version: $(npm --version 2>&1 || echo 'not found')"
          echo "PM2 location: $(which pm2 2>&1 || echo 'not found')"

          # Auto-install Node.js via NVM if not found
          if ! command -v npm &> /dev/null; then
            echo "========================================="
            echo "Node.js not found. Installing via NVM..."
            echo "========================================="

            # Temporarily disable 'set -u' for NVM operations
            set +u

            # Install NVM if not present
            if [ ! -s "$HOME/.nvm/nvm.sh" ]; then
              echo "Installing NVM..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
            fi

            # Install Node.js LTS
            echo "Installing Node.js LTS..."
            nvm install --lts
            nvm alias default lts/*

            # Reload NVM to use the installed version
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"

            # Install PM2 globally
            echo "Installing PM2..."
            npm install -g pm2

            # Re-enable 'set -u'
            set -u

            echo "Node.js installation complete!"
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "PM2 version: $(pm2 --version)"
            echo "========================================="
          fi

          # Final verification
          if ! command -v npm &> /dev/null; then
            echo "Error: npm still not found after installation attempt"
            echo "PATH: $PATH"
            exit 1
          fi

          # Create deploy directory with sudo if needed
          if [ ! -d "$1" ]; then
            if mkdir -p "$1" 2>/dev/null; then
              echo "Created directory: $1"
            else
              echo "Creating directory with sudo..."
              sudo mkdir -p "$1"
              sudo chown -R $USER:$USER "$1"
            fi
          fi

          # Deploy application
          tar -xzf /tmp/deploy.tar.gz -C "$1"
          rm -f /tmp/deploy.tar.gz
          cd "$1"

          # Install dependencies
          npm ci --omit=dev

          # Reload or start PM2 app
          if pm2 describe "$2" >/dev/null 2>&1; then
            pm2 reload "$2"
          else
            pm2 start index.js --name "$2"
          fi
          pm2 save
          SCRIPT_END
          chmod +x /tmp/deploy-script.sh

      - name: Copy and run deploy script
        run: |
          scp -P "$SSH_PORT" /tmp/deploy-script.sh "$SSH_USER@$SSH_HOST:/tmp/deploy-script.sh"
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "bash -l /tmp/deploy-script.sh '$DEPLOY_PATH' '$PM2_APP_NAME'"
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "rm -f /tmp/deploy-script.sh"

      - name: Cleanup key
        if: always()
        run: rm -f "$HOME/.ssh/id_ed25519"
