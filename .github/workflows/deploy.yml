name: Deploy to GCE (SSH + PM2)

on:
  push:
    branches: [main]

concurrency:
  group: gce-deploy-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}           # 例: 34.xx.xx.xx
  SSH_USER: ${{ secrets.SSH_USER }}           # 例: ubuntu
  SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}     # 例: /var/www/poc-api-vrcapi
  PM2_APP_NAME: ${{ secrets.PM2_APP_NAME }}   # 例: poc-api-vrcapi

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Build deploy bundle (no node_modules)
        run: |
          set -Eeuo pipefail
          mkdir -p .deploy
          tar --exclude='.git' --exclude='node_modules' -czf .deploy/deploy.tar.gz .

      - name: Setup SSH
        run: |
          set -Eeuo pipefail
          echo "HOME=$HOME"
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"
          # 秘密鍵配置（ed25519 推奨。secrets の末尾改行はそのままでOK）
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"
          # known_hosts 登録（ポート指定対応）
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> "$HOME/.ssh/known_hosts"

      - name: Copy bundle to server
        run: |
          set -Eeuo pipefail
          scp -P "$SSH_PORT" .deploy/deploy.tar.gz "$SSH_USER@$SSH_HOST:/tmp/deploy.tar.gz"

      - name: Install on server & restart PM2
        run: |
          set -Eeuo pipefail
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" bash -lc '
            set -Eeuo pipefail

            mkdir -p "'"$DEPLOY_PATH"'"
            tar -xzf /tmp/deploy.tar.gz -C "'"$DEPLOY_PATH"'"
            rm -f /tmp/deploy.tar.gz

            cd "'"$DEPLOY_PATH"'"
            npm ci --omit=dev

            if pm2 describe "'"$PM2_APP_NAME"'" >/dev/null 2>&1; then
              pm2 reload "'"$PM2_APP_NAME"'"
            else
              pm2 start index.js --name "'"$PM2
