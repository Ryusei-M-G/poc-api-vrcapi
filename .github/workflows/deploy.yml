name: Deploy to GCE (SSH + PM2)

on:
  push:
    branches: [main]

concurrency:
  group: gce-deploy-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

# ← 環境Secretsを使う場合は有効化（Secretsをその環境側に作成）
# environment: production

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
  PM2_APP_NAME: ${{ secrets.PM2_APP_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Validate required inputs
        run: |
          set -Eeuo pipefail
          missing=0
          for v in SSH_HOST SSH_USER SSH_PRIVATE_KEY DEPLOY_PATH PM2_APP_NAME; do
            if [ -z "${!v:-}" ]; then
              echo "::error title=Missing secret::$v is empty. Define it in GitHub Secrets."
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Build deploy bundle (no node_modules)
        run: |
          set -Eeuo pipefail
          mkdir -p .deploy
          tar --exclude='.git' --exclude='node_modules' -czf .deploy/deploy.tar.gz .

      - name: Setup SSH
        run: |
          set -Eeuo pipefail
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> "$HOME/.ssh/known_hosts"

      - name: Copy bundle to server
        run: |
          set -Eeuo pipefail
          scp -P "$SSH_PORT" .deploy/deploy.tar.gz "$SSH_USER@$SSH_HOST:/tmp/deploy.tar.gz"

      - name: Install on server & restart PM2
        run: |
          set -Eeuo pipefail
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" bash -lc '
            set -Eeuo pipefail
            mkdir -p "'"$DEPLOY_PATH"'"
            tar -xzf /tmp/deploy.tar.gz -C "'"$DEPLOY_PATH"'"
            rm -f /tmp/deploy.tar.gz

            cd "'"$DEPLOY_PATH"'"
            npm ci --omit=dev

            if pm2 describe "'"$PM2_APP_NAME"'" >/dev/null 2>&1; then
              pm2 reload "'"$PM2_APP_NAME"'"
            else
              pm2 start index.js --name "'"$PM2_APP_NAME"'"
            fi
            pm2 save
          '

      - name: Cleanup
        if: always()
        run: rm -f "$HOME/.ssh/id_ed25519"
