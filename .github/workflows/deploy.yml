name: Deploy to GCE (SSH + PM2)

on:
  push:
    branches: [main]

defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SERVER_HOST }}
      SSH_USER: ${{ secrets.SERVER_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DEPLOY_PATH: ${{ secrets.SERVER_PATH }}
      PM2_APP_NAME: poc-api-vrcapi   # ← Secretが無いので固定値にするか、PM2_APP_NAMEを作成

    steps:
      - name: Validate required inputs
        run: |
          set -Eeuo pipefail
          for v in SSH_HOST SSH_USER SSH_PRIVATE_KEY DEPLOY_PATH PM2_APP_NAME; do
            if [ -z "${!v:-}" ]; then
              echo "::error title=Missing::$v is empty."
              exit 1
            fi
          done

      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Build deploy bundle
        run: |
          set -Eeuo pipefail
          mkdir -p .deploy
          tar --exclude='.git' --exclude='node_modules' -czf .deploy/deploy.tar.gz .

      - name: Setup SSH
        run: |
          set -Eeuo pipefail
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> "$HOME/.ssh/known_hosts"

      - name: Copy bundle
        run: scp -P "$SSH_PORT" .deploy/deploy.tar.gz "$SSH_USER@$SSH_HOST:/tmp/deploy.tar.gz"

      - name: Create deploy script
        run: |
          cat > /tmp/deploy-script.sh <<'SCRIPT_END'
          #!/bin/bash
          set -Eeuo pipefail

          # Load environment files
          [ -f ~/.bashrc ] && source ~/.bashrc
          [ -f ~/.bash_profile ] && source ~/.bash_profile
          [ -f ~/.profile ] && source ~/.profile

          # Load NVM
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"

          # Try to find node/npm in common locations
          for node_path in \
            "$HOME/.nvm/versions/node/*/bin" \
            "/usr/local/bin" \
            "/opt/nodejs/bin" \
            "$HOME/.local/bin"; do
            if [ -d "$node_path" ] && [ -x "$node_path/node" ]; then
              export PATH="$node_path:$PATH"
              break
            fi
          done

          # Auto-install Node.js via NVM if not found
          if ! command -v npm &> /dev/null; then
            # Temporarily disable 'set -u' for NVM operations
            set +u

            # Install NVM if not present
            if [ ! -s "$HOME/.nvm/nvm.sh" ]; then
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
            fi

            # Install Node.js LTS
            nvm install --lts
            nvm alias default lts/*

            # Reload NVM to use the installed version
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"

            # Install PM2 globally
            npm install -g pm2

            # Re-enable 'set -u'
            set -u
          fi

          # Final verification
          if ! command -v npm &> /dev/null; then
            echo "Error: npm still not found after installation attempt"
            echo "PATH: $PATH"
            exit 1
          fi

          # Install PM2 if not found
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
            hash -r
          fi

          # Create deploy directory with sudo if needed
          if [ ! -d "$1" ]; then
            if mkdir -p "$1" 2>/dev/null; then
              echo "Created directory: $1"
            else
              echo "Creating directory with sudo..."
              sudo mkdir -p "$1"
              sudo chown -R $USER:$USER "$1"
            fi
          fi

          # Deploy application
          echo "Cleaning up destination directory: $1"
          sudo find "$1" -mindepth 1 -delete
          tar -xzf /tmp/deploy.tar.gz -C "$1"
          rm -f /tmp/deploy.tar.gz
          cd "$1"

          # Install dependencies
          npm ci --omit=dev

          # Reload or start PM2 app
          if pm2 describe "$2" >/dev/null 2>&1; then
            pm2 reload "$2"
          else
            pm2 start index.js --name "$2"
          fi
          pm2 save
          SCRIPT_END
          chmod +x /tmp/deploy-script.sh

      - name: Copy and run deploy script
        run: |
          scp -P "$SSH_PORT" /tmp/deploy-script.sh "$SSH_USER@$SSH_HOST:/tmp/deploy-script.sh"
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "bash -l /tmp/deploy-script.sh '$DEPLOY_PATH' '$PM2_APP_NAME'"
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "rm -f /tmp/deploy-script.sh"

      - name: Verify deployment
        run: |
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "bash -l" <<'VERIFY'
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"

          echo "=== PM2 Status ==="
          pm2 status
          echo ""
          echo "=== PM2 Logs (last 20 lines) ==="
          pm2 logs --lines 20 --nostream
          echo ""
          echo "=== Listening Ports ==="
          ss -tulpn | grep LISTEN || netstat -tulpn | grep LISTEN
          VERIFY

      - name: Cleanup key
        if: always()
        run: rm -f "$HOME/.ssh/id_ed25519"
