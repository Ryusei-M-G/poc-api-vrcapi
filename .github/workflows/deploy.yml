name: Deploy to GCE (SSH + PM2)

on:
  push:
    branches: [main]

defaults:
  run:
    shell: bash

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SERVER_HOST }}
      SSH_USER: ${{ secrets.SERVER_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DEPLOY_PATH: ${{ secrets.SERVER_PATH }}
      PM2_APP_NAME: poc-api-vrcapi   # ← Secretが無いので固定値にするか、PM2_APP_NAMEを作成

    steps:
      - name: Validate required inputs
        run: |
          set -Eeuo pipefail
          for v in SSH_HOST SSH_USER SSH_PRIVATE_KEY DEPLOY_PATH PM2_APP_NAME; do
            if [ -z "${!v:-}" ]; then
              echo "::error title=Missing::$v is empty."
              exit 1
            fi
          done

      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Build deploy bundle
        run: |
          set -Eeuo pipefail
          mkdir -p .deploy
          tar --exclude='.git' --exclude='node_modules' -czf .deploy/deploy.tar.gz .

      - name: Setup SSH
        run: |
          set -Eeuo pipefail
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> "$HOME/.ssh/known_hosts"

      - name: Copy bundle
        run: scp -P "$SSH_PORT" .deploy/deploy.tar.gz "$SSH_USER@$SSH_HOST:/tmp/deploy.tar.gz"

      - name: Install & PM2 restart
        run: |
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" bash <<ENDSSH
            set -Eeuo pipefail
            mkdir -p "$DEPLOY_PATH"
            tar -xzf /tmp/deploy.tar.gz -C "$DEPLOY_PATH"
            rm -f /tmp/deploy.tar.gz
            cd "$DEPLOY_PATH"
            npm ci --omit=dev
            if pm2 describe "$PM2_APP_NAME" >/dev/null 2>&1; then
              pm2 reload "$PM2_APP_NAME"
            else
              pm2 start index.js --name "$PM2_APP_NAME"
            fi
            pm2 save
          ENDSSH

      - name: Cleanup key
        if: always()
        run: rm -f "$HOME/.ssh/id_ed25519"
